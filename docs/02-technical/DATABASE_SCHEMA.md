# ğŸ—„ï¸ æ¡‘æ¢“æ™ºæŠ¤ Â· æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> **åˆ›å»ºæ—¥æœŸï¼š** 2026-02-25  
> **æ•°æ®åº“ï¼š** Supabase (PostgreSQL)  
> **é¡¹ç›® IDï¼š** rithloxzperfgiqyquch

---

## âœ… å·²åˆ›å»ºçš„æ•°æ®åº“è¡¨

### æ ¸å¿ƒè¡¨ï¼ˆ9 å¼ ï¼‰

| # | è¡¨å | è¯´æ˜ | è¡Œæ•° | RLS |
|---|------|------|------|-----|
| 1 | `users` | ç”¨æˆ·è¡¨ï¼ˆè€å¹´äºº+å®¶å±+å·¥ä½œäººå‘˜ï¼‰ | 0 | âœ… |
| 2 | `elder_family_binds` | å®¶å±ç»‘å®šå…³ç³»è¡¨ | 0 | âœ… |
| 3 | `medication_plans` | ç”¨è¯è®¡åˆ’è¡¨ | 0 | âœ… |
| 4 | `medication_records` | ç”¨è¯è®°å½•è¡¨ | 0 | âœ… |
| 5 | `health_records` | å¥åº·è®°å½•è¡¨ | 0 | âœ… |
| 6 | `elder_care_messages` | æ‚è¯æ¶ˆæ¯è¡¨ | 0 | âœ… |
| 7 | `ai_conversations` | AI å¯¹è¯è®°å½•è¡¨ | 0 | âœ… |
| 8 | `emergency_calls` | ç´§æ€¥å‘¼å«è®°å½•è¡¨ | 0 | âœ… |
| 9 | `health_broadcasts` | å¥åº·å¹¿æ’­å†…å®¹è¡¨ | 0 | âœ… |
| 10 | `broadcast_play_history` | å¹¿æ’­æ’­æ”¾è®°å½•è¡¨ | 0 | âœ… |

---

## ğŸ“Š æ•°æ®åº“ ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”‚  (ç”¨æˆ·è¡¨)        â”‚
â”‚                 â”‚
â”‚ â€¢ id (PK)       â”‚
â”‚ â€¢ phone (UK)    â”‚
â”‚ â€¢ role          â”‚ â† elder / family / staff
â”‚ â€¢ name          â”‚
â”‚ â€¢ chronic_diseases â”‚
â”‚ â€¢ wake_word     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                  â”‚
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ elder_family_binds  â”‚          â”‚  medication_plans    â”‚
â”‚  (å®¶å±ç»‘å®š)          â”‚          â”‚   (ç”¨è¯è®¡åˆ’)          â”‚
â”‚                     â”‚          â”‚                      â”‚
â”‚ â€¢ elder_id (FK)     â”‚          â”‚ â€¢ user_id (FK)       â”‚
â”‚ â€¢ family_id (FK)    â”‚          â”‚ â€¢ medicine_name      â”‚
â”‚ â€¢ relation          â”‚          â”‚ â€¢ schedule_times[]   â”‚
â”‚ â€¢ bind_code         â”‚          â”‚ â€¢ start_date         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                  â”‚
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ elder_care_messages â”‚          â”‚ medication_records   â”‚
â”‚  (æ‚è¯æ¶ˆæ¯)          â”‚          â”‚  (ç”¨è¯è®°å½•)           â”‚
â”‚                     â”‚          â”‚                      â”‚
â”‚ â€¢ sender_id (FK)    â”‚          â”‚ â€¢ plan_id (FK)       â”‚
â”‚ â€¢ receiver_id (FK)  â”‚          â”‚ â€¢ scheduled_time     â”‚
â”‚ â€¢ type              â”‚          â”‚ â€¢ taken_at           â”‚
â”‚ â€¢ audio_url         â”‚          â”‚ â€¢ status             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                  â”‚
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  health_records     â”‚          â”‚  ai_conversations    â”‚
â”‚  (å¥åº·è®°å½•)          â”‚          â”‚  (AI å¯¹è¯)            â”‚
â”‚                     â”‚          â”‚                      â”‚
â”‚ â€¢ user_id (FK)      â”‚          â”‚ â€¢ user_id (FK)       â”‚
â”‚ â€¢ record_type       â”‚          â”‚ â€¢ user_input         â”‚
â”‚ â€¢ values (JSONB)    â”‚          â”‚ â€¢ ai_response        â”‚
â”‚ â€¢ measured_at       â”‚          â”‚ â€¢ intent             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                  â”‚
         â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  emergency_calls    â”‚          â”‚  health_broadcasts   â”‚
â”‚  (ç´§æ€¥å‘¼å«)          â”‚          â”‚  (å¥åº·å¹¿æ’­)           â”‚
â”‚                     â”‚          â”‚                      â”‚
â”‚ â€¢ user_id (FK)      â”‚          â”‚ â€¢ title              â”‚
â”‚ â€¢ trigger_method    â”‚          â”‚ â€¢ content            â”‚
â”‚ â€¢ status            â”‚          â”‚ â€¢ audio_url          â”‚
â”‚ â€¢ location (JSONB)  â”‚          â”‚ â€¢ category           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ broadcast_play_historyâ”‚
                                 â”‚  (æ’­æ”¾è®°å½•)           â”‚
                                 â”‚                      â”‚
                                 â”‚ â€¢ user_id (FK)       â”‚
                                 â”‚ â€¢ broadcast_id (FK)  â”‚
                                 â”‚ â€¢ played_at          â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ è¡¨ç»“æ„è¯¦ç»†è¯´æ˜

### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨æ‰€æœ‰ç”¨æˆ·ï¼ˆè€å¹´äººã€å®¶å±ã€å·¥ä½œäººå‘˜ï¼‰

**å…³é”®å­—æ®µ**ï¼š
- `role`: è§’è‰²ç±»å‹ï¼ˆelder / family / staffï¼‰
- `chronic_diseases`: æ…¢æ€§ç—…åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰
- `wake_word`: è‡ªå®šä¹‰å”¤é†’è¯ï¼ˆé»˜è®¤"å°æŠ¤"ï¼‰
- `font_size`: å­—ä½“å¤§å°è®¾ç½®
- `voice_speed`: è¯­éŸ³æ’­æ”¾é€Ÿåº¦

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®

---

### 2. elder_family_bindsï¼ˆå®¶å±ç»‘å®šå…³ç³»è¡¨ï¼‰

**ç”¨é€”**ï¼šç®¡ç†è€å¹´äººä¸å®¶å±çš„åŒå‘ç»‘å®šå…³ç³»

**å…³é”®å­—æ®µ**ï¼š
- `elder_id`: è€å¹´äºº ID
- `family_id`: å®¶å± ID
- `relation`: å…³ç³»ç±»å‹ï¼ˆå„¿å­ã€å¥³å„¿ã€é…å¶ç­‰ï¼‰
- `bind_code`: 6 ä½æ•°å­—ç»‘å®šç 
- `can_view_health`: å®¶å±æ˜¯å¦å¯æŸ¥çœ‹å¥åº·æ•°æ®
- `can_edit_medication`: å®¶å±æ˜¯å¦å¯ç¼–è¾‘ç”¨è¯è®¡åˆ’
- `can_receive_emergency`: å®¶å±æ˜¯å¦æ¥æ”¶ç´§æ€¥é€šçŸ¥

**RLS ç­–ç•¥**ï¼š
- åªèƒ½æŸ¥çœ‹è‡ªå·±ç›¸å…³çš„ç»‘å®šå…³ç³»

**å”¯ä¸€çº¦æŸ**ï¼š
- `(elder_id, family_id)` ç¡®ä¿åŒä¸€å¯¹å…³ç³»åªèƒ½ç»‘å®šä¸€æ¬¡

---

### 3. medication_plansï¼ˆç”¨è¯è®¡åˆ’è¡¨ï¼‰

**ç”¨é€”**ï¼šå®šä¹‰è€å¹´äººçš„ç”¨è¯è®¡åˆ’

**å…³é”®å­—æ®µ**ï¼š
- `medicine_name`: è¯å“åç§°
- `dosage`: å‰‚é‡ï¼ˆå¦‚"1ç‰‡"ã€"2ç²’"ï¼‰
- `schedule_times`: æ¯æ—¥æœç”¨æ—¶é—´ç‚¹æ•°ç»„ï¼ˆå¦‚ `['08:00', '14:00', '20:00']`ï¼‰
- `remind_before_minutes`: æå‰å¤šå°‘åˆ†é’Ÿæé†’
- `start_date` / `end_date`: ç”¨è¯å‘¨æœŸ
- `repeat_days`: é‡å¤æ—¥æœŸï¼ˆ1-7 è¡¨ç¤ºå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
- `is_active`: æ˜¯å¦æ¿€æ´»

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç”¨è¯è®¡åˆ’

---

### 4. medication_recordsï¼ˆç”¨è¯è®°å½•è¡¨ï¼‰

**ç”¨é€”**ï¼šè®°å½•æ¯æ¬¡ç”¨è¯çš„å®é™…æƒ…å†µ

**å…³é”®å­—æ®µ**ï¼š
- `plan_id`: å…³è”çš„ç”¨è¯è®¡åˆ’
- `scheduled_time`: è®¡åˆ’æœç”¨æ—¶é—´
- `taken_at`: å®é™…æœç”¨æ—¶é—´
- `status`: æœç”¨çŠ¶æ€ï¼ˆpending / taken / skipped / delayedï¼‰
- `delayed_count`: å»¶è¿Ÿæ¬¡æ•°

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç”¨è¯è®°å½•

---

### 5. health_recordsï¼ˆå¥åº·è®°å½•è¡¨ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨è¡€å‹ã€è¡€ç³–ç­‰å¥åº·æ•°æ®

**å…³é”®å­—æ®µ**ï¼š
- `record_type`: è®°å½•ç±»å‹ï¼ˆblood_pressure / blood_sugar / heart_rate / weight / temperatureï¼‰
- `values`: JSONB æ ¼å¼å­˜å‚¨çµæ´»çš„å¥åº·æ•°æ®
  - è¡€å‹ç¤ºä¾‹ï¼š`{"systolic": 135, "diastolic": 85, "unit": "mmHg"}`
  - è¡€ç³–ç¤ºä¾‹ï¼š`{"value": 6.5, "unit": "mmol/L", "timing": "fasting"}`
- `measured_at`: æµ‹é‡æ—¶é—´
- `is_abnormal`: æ˜¯å¦å¼‚å¸¸
- `input_method`: å½•å…¥æ–¹å¼ï¼ˆvoice / manual / device / familyï¼‰
- `recorded_by`: è°å½•å…¥çš„ï¼ˆå®¶å±ä»£å½•ï¼‰

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„è®°å½•
- å®¶å±å¯æŸ¥çœ‹å·²ç»‘å®šè€äººçš„è®°å½•

---

### 6. elder_care_messagesï¼ˆæ‚è¯æ¶ˆæ¯è¡¨ï¼‰

**ç”¨é€”**ï¼šè€å¹´äººä¸å®¶å±ä¹‹é—´çš„è¯­éŸ³ç•™è¨€å’Œæ–‡å­—èŠå¤©

**å…³é”®å­—æ®µ**ï¼š
- `sender_id` / `receiver_id`: å‘é€è€…å’Œæ¥æ”¶è€…
- `type`: æ¶ˆæ¯ç±»å‹ï¼ˆvoice / textï¼‰
- `content`: æ–‡å­—å†…å®¹ï¼ˆæ–‡å­—æ¶ˆæ¯ / è¯­éŸ³è½¬å†™æ–‡æœ¬ï¼‰
- `audio_url`: è¯­éŸ³æ–‡ä»¶ URL
- `audio_duration`: è¯­éŸ³æ—¶é•¿ï¼ˆç§’ï¼‰
- `is_read`: æ˜¯å¦å·²è¯»
- `is_ai_generated`: æ˜¯å¦ç”± AI æ‚è¯åŠŸèƒ½ç”Ÿæˆ

**RLS ç­–ç•¥**ï¼š
- åªèƒ½æŸ¥çœ‹è‡ªå·±å‘é€æˆ–æ¥æ”¶çš„æ¶ˆæ¯

---

### 7. ai_conversationsï¼ˆAI å¯¹è¯è®°å½•è¡¨ï¼‰

**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·ä¸è¯­éŸ³åŠ©æ‰‹çš„æ‰€æœ‰å¯¹è¯

**å…³é”®å­—æ®µ**ï¼š
- `user_input`: ç”¨æˆ·è¯´çš„è¯ï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰
- `ai_response`: AI å›å¤å†…å®¹
- `user_audio_url` / `ai_audio_url`: è¯­éŸ³æ–‡ä»¶ URL
- `intent`: AI è¯†åˆ«çš„ç”¨æˆ·æ„å›¾ï¼ˆå¦‚ `record_health`, `check_medication`ï¼‰
- `entities`: æå–çš„å®ä½“ä¿¡æ¯ï¼ˆJSONBï¼‰
- `action_taken`: AI æ‰§è¡Œçš„åŠ¨ä½œï¼ˆå¦‚ `created_health_record`ï¼‰
- `action_result`: åŠ¨ä½œæ‰§è¡Œç»“æœï¼ˆJSONBï¼‰
- `session_id`: ä¼šè¯ IDï¼ˆåŒä¸€æ¬¡è¿ç»­å¯¹è¯ï¼‰
- `turn_number`: å¯¹è¯è½®æ¬¡

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„å¯¹è¯è®°å½•

---

### 8. emergency_callsï¼ˆç´§æ€¥å‘¼å«è®°å½•è¡¨ï¼‰

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ç´§æ€¥å‘¼å«äº‹ä»¶

**å…³é”®å­—æ®µ**ï¼š
- `trigger_method`: è§¦å‘æ–¹å¼ï¼ˆbutton / voice / autoï¼‰
- `status`: çŠ¶æ€ï¼ˆtriggered / calling / answered / cancelled / failedï¼‰
- `called_numbers`: æ‹¨æ‰“çš„ç”µè¯å·ç åˆ—è¡¨
- `location`: ä½ç½®ä¿¡æ¯ï¼ˆJSONBï¼‰
- `triggered_at` / `answered_at` / `ended_at`: æ—¶é—´è®°å½•
- `cancelled_by`: è°å–æ¶ˆçš„
- `recording_url`: å½•éŸ³æ–‡ä»¶ URLï¼ˆV2 åŠŸèƒ½ï¼‰
- `notified_families`: å·²é€šçŸ¥çš„å®¶å± ID åˆ—è¡¨

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„ç´§æ€¥å‘¼å«
- å®¶å±å¯æŸ¥çœ‹å·²ç»‘å®šè€äººçš„ç´§æ€¥å‘¼å«

---

### 9. health_broadcastsï¼ˆå¥åº·å¹¿æ’­å†…å®¹è¡¨ï¼‰

**ç”¨é€”**ï¼šAI ç”Ÿæˆçš„å¥åº·ç§‘æ™®å†…å®¹

**å…³é”®å­—æ®µ**ï¼š
- `title` / `content`: æ ‡é¢˜å’Œå†…å®¹
- `category`: å†…å®¹åˆ†ç±»ï¼ˆnutrition / exercise / seasonal / medication / sleepï¼‰
- `audio_url` / `audio_duration`: éŸ³é¢‘æ–‡ä»¶å’Œæ—¶é•¿
- `target_age_min` / `target_age_max`: ç›®æ ‡å¹´é¾„èŒƒå›´
- `target_diseases`: é€‚ç”¨çš„æ…¢æ€§ç—…ç±»å‹ï¼ˆæ•°ç»„ï¼‰
- `target_season`: é€‚ç”¨å­£èŠ‚
- `ai_prompt`: ä½¿ç”¨çš„ AI æç¤ºè¯
- `generated_by`: AI æ¨¡å‹åç§°ï¼ˆé»˜è®¤ `doubao`ï¼‰
- `is_published`: æ˜¯å¦å·²å‘å¸ƒ
- `play_count`: æ’­æ”¾æ¬¡æ•°

**RLS ç­–ç•¥**ï¼š
- æ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹å·²å‘å¸ƒçš„å¹¿æ’­

---

### 10. broadcast_play_historyï¼ˆå¹¿æ’­æ’­æ”¾è®°å½•è¡¨ï¼‰

**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·æ”¶å¬å¥åº·å¹¿æ’­çš„å†å²

**å…³é”®å­—æ®µ**ï¼š
- `user_id` / `broadcast_id`: ç”¨æˆ·å’Œå¹¿æ’­å†…å®¹
- `played_at`: æ’­æ”¾æ—¶é—´
- `play_duration`: å®é™…æ’­æ”¾æ—¶é•¿ï¼ˆç§’ï¼‰
- `completed`: æ˜¯å¦æ’­æ”¾å®Œæ•´
- `liked`: ç”¨æˆ·æ˜¯å¦ç‚¹èµ

**RLS ç­–ç•¥**ï¼š
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ’­æ”¾è®°å½•

**å”¯ä¸€çº¦æŸ**ï¼š
- `(user_id, broadcast_id)` åŒä¸€ç”¨æˆ·åŒä¸€å†…å®¹åªè®°å½•æœ€æ–°ä¸€æ¬¡æ’­æ”¾

---

## ğŸ” å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰

æ‰€æœ‰è¡¨éƒ½å·²å¯ç”¨ **Row Level Security (RLS)**ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ï¼š

### åŸºæœ¬åŸåˆ™

1. **ç”¨æˆ·æ•°æ®éš”ç¦»**ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
2. **å®¶å±æƒé™**ï¼šå®¶å±å¯æŸ¥çœ‹å·²ç»‘å®šè€äººçš„å¥åº·æ•°æ®ï¼ˆé€šè¿‡ `elder_family_binds` è¡¨ï¼‰
3. **å…¬å¼€å†…å®¹**ï¼šå¥åº·å¹¿æ’­ç­‰å…¬å¼€å†…å®¹æ‰€æœ‰äººå¯æŸ¥çœ‹

### RLS ç­–ç•¥ç¤ºä¾‹

```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own data"
  ON users FOR SELECT
  USING (auth.uid()::text = id::text);

-- ç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±ç›¸å…³çš„ç»‘å®šå…³ç³»
CREATE POLICY "Users can view own bindings"
  ON elder_family_binds FOR SELECT
  USING (
    auth.uid()::text = elder_id::text OR 
    auth.uid()::text = family_id::text
  );

-- æ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹å·²å‘å¸ƒçš„å¹¿æ’­
CREATE POLICY "Anyone can view published broadcasts"
  ON health_broadcasts FOR SELECT
  USING (is_published = TRUE);
```

---

## ğŸ“ˆ ç´¢å¼•ä¼˜åŒ–

æ‰€æœ‰è¡¨éƒ½å·²åˆ›å»ºå¿…è¦çš„ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼š

### å¸¸ç”¨ç´¢å¼•

```sql
-- ç”¨æˆ·è¡¨
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_last_active ON users(last_active_at);

-- ç”¨è¯è®°å½•
CREATE INDEX idx_med_records_scheduled ON medication_records(scheduled_time);
CREATE INDEX idx_med_records_status ON medication_records(status);

-- å¥åº·è®°å½•
CREATE INDEX idx_health_measured ON health_records(measured_at DESC);
CREATE INDEX idx_health_abnormal ON health_records(is_abnormal);
CREATE INDEX idx_health_values ON health_records USING GIN (values);

-- æ¶ˆæ¯
CREATE INDEX idx_elder_messages_unread ON elder_care_messages(receiver_id, is_read) 
  WHERE is_read = FALSE;

-- AI å¯¹è¯
CREATE INDEX idx_ai_conv_session ON ai_conversations(session_id);
CREATE INDEX idx_ai_conv_intent ON ai_conversations(intent);
```

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. åˆ›å»ºæµ‹è¯•æ•°æ®

```sql
-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆè€å¹´äººï¼‰
INSERT INTO users (phone, role, name, chronic_diseases, wake_word)
VALUES ('13800138000', 'elder', 'å¼ çˆ·çˆ·', ARRAY['é«˜è¡€å‹', 'ç³–å°¿ç—…'], 'å°æŠ¤');

-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆå®¶å±ï¼‰
INSERT INTO users (phone, role, name)
VALUES ('13900139000', 'family', 'å¼ å°çº¢');

-- åˆ›å»ºç»‘å®šå…³ç³»
INSERT INTO elder_family_binds (elder_id, family_id, relation, bind_code)
VALUES (
  (SELECT id FROM users WHERE phone = '13800138000'),
  (SELECT id FROM users WHERE phone = '13900139000'),
  'å¥³å„¿',
  '382916'
);
```

### 2. é…ç½® Supabase Storage

åˆ›å»ºå­˜å‚¨æ¡¶ç”¨äºå­˜å‚¨ï¼š
- è¯­éŸ³æ–‡ä»¶ï¼ˆæ‚è¯ã€AI å¯¹è¯ï¼‰
- ç”¨æˆ·å¤´åƒ
- å¥åº·å¹¿æ’­éŸ³é¢‘

```sql
-- åœ¨ Supabase Dashboard ä¸­åˆ›å»º Storage Buckets:
-- 1. elder-care-audio (è¯­éŸ³æ–‡ä»¶)
-- 2. elder-care-avatars (å¤´åƒ)
-- 3. health-broadcast-audio (å¥åº·å¹¿æ’­)
```

### 3. ç”Ÿæˆ TypeScript ç±»å‹

ä½¿ç”¨ Supabase MCP Server ç”Ÿæˆç±»å‹å®šä¹‰ï¼š

```typescript
// åœ¨ Kiro ä¸­æ‰§è¡Œï¼š
"è¯·ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰"
```

### 4. è®¾ç½® Realtime è®¢é˜…

ä¸ºå®æ—¶åŠŸèƒ½å¯ç”¨ Realtimeï¼š
- ç”¨è¯æé†’
- æ‚è¯æ¶ˆæ¯
- ç´§æ€¥å‘¼å«é€šçŸ¥

---

## ğŸ“ æ•°æ®åº“è¿ç§»è®°å½•

| è¿ç§»åç§° | åˆ›å»ºæ—¶é—´ | çŠ¶æ€ |
|---------|---------|------|
| `create_users_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_elder_family_binds_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_medication_tables` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_health_records_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_elder_care_messages_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_ai_conversations_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_emergency_calls_table` | 2026-02-25 | âœ… æˆåŠŸ |
| `create_health_broadcasts_table_v2` | 2026-02-25 | âœ… æˆåŠŸ |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [äº§å“è§„æ ¼ä¹¦](PRODUCT_SPEC.md)
- [å¼€å‘è®¡åˆ’](plan.md)
- [Kiro é…ç½®æŒ‡å—](KIRO_CONFIGURATION_GUIDE.md)
- [MCP Powers æ¨è](MCP_POWERS_RECOMMENDATIONS.md)

---

*æ•°æ®åº“è®¾è®¡åŸºäºäº§å“è§„æ ¼ä¹¦ v1.0ï¼Œæ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚*
